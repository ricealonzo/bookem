<p style="color: green"><%= notice %></p>


<div class="location_show_container">

  <%= render @location %>

  <% full_address = [@location.address, @location.city, @location.state, @location.postal_code].compact.join(", ") %>
  <div class="mt-3">
    <h2>Map</h2>
    <p class="location-address"><%= full_address.presence || "Address unavailable" %></p>
    <div
      id="map"
      class="location-map"
      data-address="<%= full_address %>"
      data-mapbox-token="<%= ENV.fetch("MAPBOX_ACCESS_TOKEN", "") %>">
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const mapElement = document.getElementById("map");
    if (!mapElement) return;

    const token = mapElement.dataset.mapboxToken;
    const address = mapElement.dataset.address;

    if (!token || !address) {
      mapElement.innerHTML = "<p class=\"map-error\">Map is unavailable.</p>";
      return;
    }

    mapboxgl.accessToken = token;

    const geocodeUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${token}&limit=1`;

    fetch(geocodeUrl)
      .then((response) => response.ok ? response.json() : Promise.reject(response))
      .then((data) => {
        const feature = data.features && data.features[0];
        if (!feature) throw new Error("No geocode result");

        const [lng, lat] = feature.center;
        const map = new mapboxgl.Map({
          container: "map",
          style: "mapbox://styles/mapbox/standard",
          zoom: 12,
          center: [lng, lat]
        });

        map.addControl(new mapboxgl.NavigationControl());
        new mapboxgl.Marker().setLngLat([lng, lat]).addTo(map);
      })
      .catch(() => {
        mapElement.innerHTML = "<p class=\"map-error\">Unable to load the map for this address.</p>";
      });
  });
</script>


<h2>Bookings Calendar</h2>

<%= month_calendar(events: @bookings, attribute: :started_at, end_attribute: :ended_at) do |date, bookings| %>
  <div class="day">
    <div class="fw-bold"><%= date.day %></div>

    <% bookings.each do |booking| %>
      <% started_at = booking.started_at.present? ? Time.zone.parse(booking.started_at.to_s) : nil %>
      <% ended_at = booking.ended_at.present? ? Time.zone.parse(booking.ended_at.to_s) : nil %>

      <div class="card-sm text-truncate" style="width: 4rem;">
        <div class="card-header">
          <div class="card-title">
            (<%= link_to booking.guest.email, booking %>)
          </div>
        </div>

        <div class="card-footer">
          <% if started_at && ended_at %>
            <p class="card-text"><%= started_at.strftime("%H:%M %p") %> to <%= ended_at.strftime("%H:%M %p") %></p>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% end %>




<div>
  <%= link_to "Back to locations", locations_path %>

  <% if current_user&.id == @location.host_id %>
    <%= link_to "Edit this location", edit_location_path(@location) %> |
    <%= button_to "Destroy this location", @location, method: :delete %>
  <% end %>
</div>
